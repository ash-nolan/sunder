# Verify that reallocating where the new total size requires a different number
# of pages than the old total size does not lead to any unexpected behavior.

import "std";
import "sys";

func main() void {
    var allocator = std::allocator::init[[std::page_allocator]](std::page_allocator::the());

    var bytes = std::slice[[byte]]::new_with_allocator(allocator, 0);
    defer std::slice[[byte]]::delete_with_allocator(allocator, bytes);

    var MAX = sys::PAGE_SIZE * 5 + 1;
    for i in 0:(MAX + 1) {
        bytes = std::slice[[byte]]::resize_with_allocator(allocator, bytes, i);
        # Write to all the bytes to make sure no page fault occurs.
        std::slice[[byte]]::fill(bytes, (:byte)i);
    }
    for i in 0:(MAX + 1) {
        bytes = std::slice[[byte]]::resize_with_allocator(allocator, bytes, MAX - i);
        # Write to all the bytes to make sure no page fault occurs.
        std::slice[[byte]]::fill(bytes, (:byte)i);
    }
}
