import "std/formatter.sunder";
import "std/io.sunder";
import "std/writer.sunder";

struct person {
    var name: []byte;

    func format(self: *person, writer: *std::writer, fmt: []byte) std::result[[:usize, :[]byte]] {
        if countof(fmt) != 0 {
            return std::result[[:usize, :[]byte]]::init_error(std::formatter::INVALID_FORMAT_SPECIFIER);
        }
        return writer.*.write_all(self.*.name);
    }
}

struct int {
    func format(self: *int, writer: *std::writer, fmt: []byte) std::result[[:usize, :[]byte]] {
        if countof(fmt) == 0 {
            return writer.*.write_all("decimal");
        }

        var c: byte = fmt[0];
        if c == 'd' {
            return writer.*.write_all("decimal");
        }
        if c == 'b' {
            return writer.*.write_all("binary");
        }
        if c == 'o' {
            return writer.*.write_all("octal");
        }
        if c == 'x' {
            return writer.*.write_all("hexadecimal");
        }
        return std::result[[:usize, :[]byte]]::init_error(std::formatter::INVALID_FORMAT_SPECIFIER);
    }
}

func test0() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};
    var bob: person = (:person){.name = "Bob"};

    var args: [2]std::formatter = (:[2]std::formatter)[
        std::formatter::init[[:person]](&alice),
        std::formatter::init[[:person]](&bob)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "{} and {}", args[0:countof(args)]);
    writer.write("\n"); # Separate '\n' to test format string ending in "{}".
    dump res.value();
}

func test1() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    const i: int = (:int){};

    var args: [5]std::formatter = (:[5]std::formatter)[
        std::formatter::init[[:int]](&i),
        std::formatter::init[[:int]](&i),
        std::formatter::init[[:int]](&i),
        std::formatter::init[[:int]](&i),
        std::formatter::init[[:int]](&i)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "{} {d} {b} {o} {x}\n", args[0:countof(args)]);
    dump res.value();
}

func test2() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};
    var bob: person = (:person){.name = "Bob"};

    var args: [2]std::formatter = (:[2]std::formatter)[
        std::formatter::init[[:person]](&alice),
        std::formatter::init[[:person]](&bob)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "{{ {} {{ {} {{\n", args[0:countof(args)]);
    dump res.value();
}

func test3() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};
    var bob: person = (:person){.name = "Bob"};

    var args: [2]std::formatter = (:[2]std::formatter)[
        std::formatter::init[[:person]](&alice),
        std::formatter::init[[:person]](&bob)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "}} {} }} {} }}\n", args[0:countof(args)]);
    dump res.value();
}

func test4() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};

    var args: [1]std::formatter = (:[1]std::formatter)[
        std::formatter::init[[:person]](&alice)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "{{{}\n", args[0:countof(args)]);
    dump res.value();
}

func test5() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};

    var args: [1]std::formatter = (:[1]std::formatter)[
        std::formatter::init[[:person]](&alice)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "{}}}\n", args[0:countof(args)]);
    std::err.println(res.error());
}

func test6() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};

    var args: [1]std::formatter = (:[1]std::formatter)[
        std::formatter::init[[:person]](&alice)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "foo{", args[0:countof(args)]);
    std::err.println(res.error());
}

func test7() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};

    var args: [1]std::formatter = (:[1]std::formatter)[
        std::formatter::init[[:person]](&alice)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "bar}", args[0:countof(args)]);
    std::err.println(res.error());
}

func test8() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};

    var args: [1]std::formatter = (:[1]std::formatter)[
        std::formatter::init[[:person]](&alice)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "baz}qux", args[0:countof(args)]);
    std::err.println(res.error());
}

func test9() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};
    var bob: person = (:person){.name = "Bob"};

    var args: [2]std::formatter = (:[2]std::formatter)[
        std::formatter::init[[:person]](&alice),
        std::formatter::init[[:person]](&bob)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "{} and {} and {}\n", args[0:countof(args)]);
    std::err.println(res.error());
}

func test10() void {
    var writer: std::writer = std::writer::init[[:std::stream]](&std::out);

    var alice: person = (:person){.name = "Alice"};

    var args: [1]std::formatter = (:[1]std::formatter)[
        std::formatter::init[[:person]](&alice)
    ];
    var res: std::result[[:usize, :[]byte]] =
        std::write_format(&writer, "foo{bar", args[0:countof(args)]);
    std::err.println(res.error());
}

func main() void {
    test0();
    test1();
    test2();
    test3();
    test4();
    test5();
    test6();
    test7();
    test8();
    test9();
    test10();
}
################################################################################
# Alice and Bob
# 0D 00 00 00 00 00 00 00
# decimal decimal binary octal hexadecimal
# 29 00 00 00 00 00 00 00
# { Alice { Bob {
# 10 00 00 00 00 00 00 00
# } Alice } Bob }
# 10 00 00 00 00 00 00 00
# {Alice
# 07 00 00 00 00 00 00 00
# invalid format string
# invalid format string
# invalid format string
# invalid format string
# Alice and Bob and invalid format argument count
# fooinvalid format string
