import "std/formatter.sunder";
import "std/io.sunder";
import "std/panic.sunder";
import "std/writer.sunder";

struct name {
    var first: []byte;
    var last: []byte;

    func init(first: []byte, last: []byte) name {
        return (:name){.first = first, .last = last};
    }

    func format(self: *name, writer: *std::writer, format: []byte) void {
        if (countof(format) != 0) {
            std::panic("format error");
        }
        writer.*.vtable.*.write(writer.*.self, self.*.first);
        writer.*.vtable.*.write(writer.*.self, " ");
        writer.*.vtable.*.write(writer.*.self, self.*.last);
    }
}

struct int {
    # Pretend this is some std::* integer type that accepts a format specifier
    # of "d" to be printed in decimal, "b" to be printed in binary, "o" to be
    # printed in octal, or "x" to be printed in hexadecimal. For not we'll
    # avoid the actual int->bytes conversion part and just print the specifier
    # choice.
    func format(self: *name, writer: *std::writer, format: []byte) void {
        if (countof(format) != 1) {
            std::panic("format error");
        }
        var c: byte = format[0];
        if (c == 'd') {
            writer.*.vtable.*.write(writer.*.self, "decimal\n");
            return;
        }
        if (c == 'b') {
            writer.*.vtable.*.write(writer.*.self, "binary\n");
            return;
        }
        if (c == 'o') {
            writer.*.vtable.*.write(writer.*.self, "octal\n");
            return;
        }
        if (c == 'x') {
            writer.*.vtable.*.write(writer.*.self, "hexadecimal\n");
            return;
        }
        std::panic("format error");
    }
}

func main() void {
    var writer: std::writer =
        std::writer::init[[:std::stream]](&std::stdout);

    var a: name = name::init("Nona", "Gaprindashvili");
    var b: name = name::init("Judit", "Polgar");

    var a_formatter: std::formatter = std::formatter::init[[:name]](&a);
    var b_formatter: std::formatter = std::formatter::init[[:name]](&b);

    a_formatter.vtable.*.format(a_formatter.self, &writer, "");
    writer.vtable.*.write(writer.self, " and ");
    b_formatter.vtable.*.format(b_formatter.self, &writer, "");
    writer.vtable.*.write(writer.self, " are amazing players!\n");

    var i: int = (:int){};
    var i_formatter: std::formatter = std::formatter::init[[:int]](&i);
    i_formatter.vtable.*.format(i_formatter.self, &writer, "d");
    i_formatter.vtable.*.format(i_formatter.self, &writer, "b");
    i_formatter.vtable.*.format(i_formatter.self, &writer, "o");
    i_formatter.vtable.*.format(i_formatter.self, &writer, "x");
    i_formatter.vtable.*.format(i_formatter.self, &writer, "boom");
}
################################################################################
# Nona Gaprindashvili and Judit Polgar are amazing players!
# decimal
# binary
# octal
# hexadecimal
# panic: format error
