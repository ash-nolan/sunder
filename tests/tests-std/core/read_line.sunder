import "std/core.sunder";
import "std/fs.sunder";
import "std/page_allocator.sunder";

func test0() void {
    var open_result = std::fs::file::open("data.txt", std::fs::OPEN_READ);
    var file: std::fs::file = open_result.value();

    var reader = std::reader::init[[std::fs::file]](&file);
    var allocator = std::page_allocator::the();

    for true {
        var read_result = std::read_line(reader, allocator);
        var optional = read_result.value();
        if optional.is_empty() {
            break;
        }
        var bytes = optional.value();
        std::print_line(std::out(), bytes);
        std::delete_slice[[byte]](allocator, bytes);
    }

    file.close();
}

func test1() void {
    var open_result = std::fs::file::open("data-no-ending-newline.txt", std::fs::OPEN_READ);
    var file: std::fs::file = open_result.value();

    var reader = std::reader::init[[std::fs::file]](&file);
    var allocator = std::page_allocator::the();

    for true {
        var read_result = std::read_line(reader, allocator);
        var optional = read_result.value();
        if optional.is_empty() {
            break;
        }
        var bytes = optional.value();
        std::print_line(std::out(), bytes);
        std::delete_slice[[byte]](allocator, bytes);
    }

    file.close();
}

# Read a single line and report the result.
func test2() void {
    var open_result = std::fs::file::open("data.txt", std::fs::OPEN_READ);
    var file: std::fs::file = open_result.value();

    var reader = std::reader::init[[std::fs::file]](&file);
    var allocator = std::page_allocator::the();

    var read_result = std::read_line(reader, allocator);
    var optional = read_result.value();
    var bytes = optional.value();
    std::print_line(std::out(), bytes);
    std::delete_slice[[byte]](allocator, bytes);

    file.close();
}

func main() void {
    test0();
    test1();
    test2();
}
################################################################################
# TEST DATA FILE LINE 1
# TEST DATA FILE LINE 2
# TEST DATA FILE LINE 1
# TEST DATA FILE LINE 2
# TEST DATA FILE LINE 3 (NO NEWLINE)
# TEST DATA FILE LINE 1
