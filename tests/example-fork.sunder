import "std";
import "sys";

func main() void {
    var sysret = sys::fork();
    if sysret < 0 {
        std::panic("fork failed");
    }

    var pid = (:sys::sint)sysret;
    if pid == 0 {
        std::print_line(std::out(), "child");
        std::exit(42);
    }

    var status: sys::sint = 0;
    var rusage: sys::rusage = std::zeroed[[sys::rusage]]();
    var sysret = sys::wait4(pid, &status, 0, &rusage);
    if sysret < 0 {
        std::panic("wait4 failed");
    }

    var exit_status = sys::WEXITSTATUS(status);
    std::print_line(std::out(), "parent");
    std::print_format_line(
        std::out(),
        "child exit status: {}",
        (:[]std::formatter)[
            std::formatter::init[[sys::sint]](&exit_status)]);
}
################################################################################
# child
# parent
# child exit status: 42
